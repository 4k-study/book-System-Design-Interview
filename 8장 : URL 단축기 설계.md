# 1단계 문제 이해 및 설계 범위 확정

질문 예시

- 동작 예시
- 트래픽 규모
- 단축된 URL 길이
- 포함 문자 제한
- URL 갱신/삭제 여부

### 개략적 추정

- 쓰기 연산 : 매일 1억개의 URL 생성
- 초당 쓰기 연산 : 1억 / 24 / 60 / 60 = 1160
- 읽기 연산 : 읽기 연산과 쓰기 연산의 비율이 10:1이면 초당 11600회 발생
- 저장 공간 : 10년동안 운영할시 3650억 레코드를 보관해야함
    - 단축 전 URL 평균 길이가 100이면 36.5TB

# 2단계 개략적 설계안 제시 및 동의 구하기

### API 엔드포인트

RESTful API를 통해 통신

1. 단축용 : POST /api/v1/data
    1. 인자 : 단축 전 URL
    2. 반환 : 단축된 URL
2. 리디렉션용 : GET /api/v1/shortUrl
    1. 반환 : 리디렉션 목적지가 될 원래 URL

### URL 리디렉션

브라우저에 단축 URL을 입력하면

Status Code 301과 location으로 목적지가 될 원래 URL을 응답한다.

- 301 : 이 응답은 HTTP 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답이다. 따라서 브라우저는 이 응답을 캐싱한다.
- 302 : 이 응답은 주어진 URL로의 요청이 **일시적으로** Location 헤더가 지정하는 URL에 의해 처리되어야 한다. 따라서 브라우저는 언제든 단축 URL 서버에 요청을 보내 처리한다.

301은 서버 부하를 줄일 수 있지만 트래픽 분석을 위해서는 302 응답을 사용하는 것이 더 유리할 것이다.

URL 리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블을 사용하는 것이다.

### URL 단축

가장 중요한 것은 URL을 해시 값으로 대응시킬 해시함수를 찾는 것이 중요하다.

해시함수 요구사항

- 입력 URL이 다르면 해시 값도 달라야 한다.
- 계산된 해시 값은 원래 입력으로 복원될 수 있어야 한다.

# 3단계 상세 설계

### 데이터 모델

해시테이블에 저장하는 것보다 <단축 URL, 원래 URL> 값 쌍에 저장하는 것이 더 좋다.

### 해시 함수

해시 값은 [0-9, a-z, A-Z] 문자로 구성된다. 따라서 사용 가능한 문자 개수는 62개이고, hashValue를 정하기 위해선 62^n ≥ 3650억을 만족하는 n의 최소값을 찾아야 한다. (7정도면 됨)

해시 함수 구현은 해시 후 충돌 해소 방법과 base-62변환법 두가지를 살펴보자.

**해시 후 충돌 해소**

보통은 CRC32, MD5, SHA-1 같이 잘 알려진 해시 함수를 이용하는 것이다.

위 해시 함수들은 모두 7글자보다 길다. 이 문제를 해결할 방법은 무엇이 있을까?

- 계산된 해시값 중 처음 7개 글자만 이용한다. → 해시 충돌 위험
- 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙인다.

**base-62 변환**

URL 단축기를 구현할 때 흔히 사용되는 접근법으로, 수의 표현 방식이 다른 두 시스템이 같은 수를 공유하는 경우 유용하다.

base-62는 62진법으로 변환하는 방법이다.

**두 접근법 비교**

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/6646274d-8cb7-4789-bcd6-d4090bb7ec44)

### URL 단축기 상세 설계

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/e9bbc31c-c9e9-4ddc-b8e0-d62fbdfea16c)

이때 새로운 ID를 생성할 때 유니크 해야한다.

### URL 리디렉션 상세 설계

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/ed501ba4-60a8-41f1-b2f4-626a64b58b4c)

쓰기보다 읽기가 잦은 시스템이라,  <단축 URL, 원래 URL> 값 쌍을 캐시에 저장해 성능을 높인다.

로드밸런서 역할

1. 사용자가 단축 URL을 클릭한다.
2. 로드 밸런서가 해당 요청을 웹서버에 전달한다.
3. 단축 URL이 캐시에 있으면 바로 클라이언트에 전달한다.
4. 캐시에 해당 단축 URL이 없는 경우에는 DB에서 꺼낸다. (없다면 잘못된 입력)
5. DB에서 꺼낸 URL을 캐시에 저장 후 반환한다.

# 4단계 마무리

설계를 마친 뒤 이런 얘기를 나눠보아도 좋을 것 같다.

- 처리율 제한 장치 : IP와 같은 필터링 규칙을 통해 요청을 걸러낼 수 있다.
- 웹 서버의 규모 확장 : http로 구성되어 stateless하기 때문에 웹서버 증설이 자유롭다.
- DB 규모 확장 : DB 다중화, 샤딩 등 고려
- 데이터 분석 솔루션 : 어떤 링크를 어떤 사용자가 얼마나 클릭하는지 정보를 알아낼 수 있다.
- 가용성, 데이터 일관성, 안정성 : 대규모 시스템을 위해 반드시 갖추어야 할 속성이다.
