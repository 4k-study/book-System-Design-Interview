# 7장 분산 시스템을 위한 유일 ID 생성기 설계

# 1단계 문제 이해 및 설계 범위 확정

적절한 질문을 통해 모호함을 없에야 한다. 다음과 같은 질문으로 설계 방향을 정해야 한다.

- ID의 특성 (정렬, 유일성, ID 간격 등)
- ID의 구성 요소 (숫자, 문자)
- 시스템 규모

# 2단계 개략적 설계안 제시 및 동의 구하기

문제의 조건에 따라서 다음과 같은 선택지를 살펴볼 수 있다.

- 다중 마스터 복제
- UUID
- 티켓 서버
- 트위터 스노플레이크 접근

### 다중 마스터 복제

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/b522df5e-cbff-493e-ba02-560fde58be22)

이 접근법은 DB의 auto_increment 기능을 활용한다. 다만 값의 증가량은 1이 아닌 k이다.

데이터베이스 수를 늘리면 ID 생성 개수도 늘어난다.

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
- ID의 유일성은 보장되지만, 시간 흐름에 맞춰 커지지 않는다.
- 서버를 추가/삭제할 때 잘 동작하도록 만들기 어렵다.

### UUID

128비트짜리 수로 충돌 가능성이 지극히 낮다.

장점

- UUID를 만드는건 간단하고 동기화 이슈도 없다.
- 각 서버에서 만들기 때문에 규모확장이 쉽다.

단점

- 128비트로 ID가 크다.
- 시간순으로 정렬이 불가능하다.
- 숫자가 아닌 값도 포함된다.

### 티켓 서버

auto_increment 기능을 갖춘 DB서버를 중앙 집중형으로 하나만 사용하는 방법이다.

플리커에선 이 기술을 사용한다.

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/61aac9ab-f230-4d81-aaf8-b992606d67b9)

장점

- 유일성이 보장되고, 숫자로만 ID를 구성할 수 있다.
- 구현하기 쉽고, 중소 규모 애플리케이션에 적합하다.

단점

- 티켓 서버가 SPOF가 된다.
    - 그렇다고 티켓 서버를 여러대 두면 동기화 이슈가 생긴다.

### 트위터 스노플레이크 접근법

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/d42f6f36-f0a8-44b1-89b1-020f4bf48e71)

divide and conquer 전략은 하나의 ID를 여러 section으로 분할하는 것이다.

- sign(1비트) : 나중을 위해 유보해둔다.
- timestamp(41비트)
- data senter ID(5비트) : 32개의 데이터센터를 지원할 수 있다.
- server ID(5비트) : 데이터센터당 32개의 서버를 사용할 수 있다.
- 일련번호(12비트) : 각 서버에는 ID를 생성할 때마다 일련번호를 1씩 증가시킨다. 이 값은 1 밀리초마다 0으로 초기화 된다.

# 3단계 상세 설계

스노우 플레이크 접근법으로 설계해보자

데이터 센터 ID와 서버 ID는 시스템이 시작할 때 결정되며 일반적으로 운영 중에는 바뀌지 않는다.

데이터센터 ID나 서버 ID를 잘못 변경하게 되면 ID 충돌이 발생할 수 있으므로 신중해야 한다.

### 타임스탬프

타임스탬프는 시간순으로 정렬이 가능하다.

UTC 시간을 추출할 수 있다.

41비트로 표현할 수 있는 타임스탬프는 69년정도이므로 마이그레이션이 필요할 수 있다.

### 일련번호

일련번호는 12비트이므로 4096개 가질 수 있다.

어떤 서버가 1 밀리초 안에 하나 이상의 ID를 만들어낸 경우에만 0보다 큰 값을 갖게 된다.

# 4단계 마무리

설계를 진행하고 시간이 조금 남았다면 면접관과 추가로 논의할 수 있다.

- 시계 동기화 : 여러가지 독립된 서버에서 실행되는 경우 NTP를 통해 문제를 해결할 수 있다.
- section 길이 최적화 : 동시성이 낮은 경우 일련번호 길이를 줄이고 타임스탬프 길이를 늘려도 좋다.
- 고 가용성 : ID 생성기는 불가결하기 때문에 높은 가용성을 제공해야 한다.
