# 11장 뉴스 피드 시스템 설계

# 1단계 문제 이해 및 설계 범위 확정

질문 목록 (**면접관의 의도를 알아내야함**)

- 모바일, 웹 지원 유무
- 중요한 기능
- 스토리 표시 순서
- 사용자의 최대 친구 수
- 트래픽 규모
- 피드에 올라올 수 있는 컨텐츠(사진, 글, 영상)

# 2단계 개략적 설계안 제시 및 동의 구하기

피드발행과, 뉴스 피드 생성 두가지로 나누어 보겠습니다.

- 피드 발생 : 사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 기록한다.
- 뉴스 피드 생성 : 지면상 뉴스 피드는 모든 친구의 포스팅을 시간 역순으로 모은다.

### 뉴스피드 API

**피드발행 API**

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/462a0e57-23e6-48e9-ac82-aedffd6a273c)

- 웹 서버 : HTTP 요청을 내부 서비스로 중계한다.
- 포스팅 저장 : 새 포스팅을 캐시와 DB에 저장한다.
- 포스팅 전송 : 새 포스팅을 친구의 뉴스 피드에 푸시한다. 캐시를 사용한다.
- 알림 서비스 : 친구들에게 새 포스팅이 올라왔음을 알리거나, 푸시 알림을 보낸다.

**뉴스 피드 생성**

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/d501e6ea-a2cb-4ebc-a149-bb31e3cc12d4)

- 뉴스 피드 서비스 : 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시 : 뉴스 피드를 렌더링할 때 필요한 피드 ID 보관

# 3단계 상세 설계

### **피드 발행 API 상세**

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/81fb4b19-53ae-411d-a271-10634e91d80f)

- 웹 서버
    - 클라이언트와 통신
    - 인증과 처리율 제한 기능 수행
    - 특정 기간동안 한 사용자가 올릴 수 있는 포스팅 수 제한
- 포스팅 전송 서비스 (새 포스팅 전송)
    - 쓰기 시점 팬아웃(푸시) : 포스팅 완료 시 해당 사용자의 캐시에 포스팅 기록
        - 뉴스 피드 실시간 갱신으로 뉴스피드 읽는 시간 감소
        - 친구가 많은 경우 피드 갱신에 많은 시간 소요됨 (hotkey)
        - 서비스를 이용하지 않는 사용자의 피드도 갱신해야 하므로 자원 낭비
    - 읽기 시점 팬아웃(풀) : 피드를 읽는 시점에 갱신한다.
        - 서비스를 이용하는 사용자의 피드 갱신해서 자원 낭비가 없음
        - hotkey 문제가 안생김
        - 뉴스 피드 읽는데 많은 시간 소요
    

**하이브리드**

두 가지 방법을 결합하여 장점을 결합하여 사용하자.

- 팔로워가 아주 많은 사용자의 경우에는 풀 모델을 사용한다.
- 대부분의 사용자에 대해서는 푸시 모델을 사용한다.
- 안정 해시를 통해 요청과 데이터를 분산하여 hotkey문제를 줄인다.

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/61289fcc-6691-49c6-b38d-f4bed78fec37)

1. 그래프 DB에서 친구 ID 목록을 가져온다.
2. 사용자 정보 캐시에서 친구 정보를 가져온다.
    1. mute한 친구를 필터링 한다.
3. 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣는다.
4. 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내어 뉴스피드 데이터를 뉴스피드 캐시에 넣는다.
    1. 캐시에는 <post ID, user ID>만 저장한다. 메모리 크기가 너무 커질 수 있어서이다.

### **피드 읽기 API 상세 설계**

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/6325d969-6c0e-497f-a04c-a73c1e572a62)

1. 사용자가 요청을 보낸다.
2. 로드 밸런서가 웹 서버 가운데 하나에 요청을 보낸다.
3. 웹 서버는 피드를 가져오기 위해 뉴스 피드 서비스를 호출한다.
4. 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록을 가져온다.
5. 뉴스 피드에 표시할 사용자 이름, 사진, 콘텐츠, 이미지 등을 캐시로부터 가져와 뉴스 피드를 만든다.
6. 해당 피드를 JSON 형태로 반환한다.

### 캐시 구조

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/0ba87355-7fbb-468b-89de-6afe15b43f1a)

- 뉴스 피드 : 뉴스 피드의 ID 보관
- 콘텐츠 : 포스팅 데이터 보관, 인기 콘텐츠는 따로 보관
- 소셜 그래프 : 사용자 간 관계 정보를 보관
- 행동 : 포스팅에 대한 사용자의 행위 정보를 보관 (좋아요, 답글 등)
- 횟수 : 좋아요, 응답, 팔로어, 팔로잉 수 보관

# 4단계 마무리

뉴스 피드는 발생과 생성 두 부분으로 구성되어있다.

설계에 정답은 없기 때문에, 제약과 요구조건을 세세히 파악하고 고려해야 한다.

기술을 선택시 어떤 배경에 의해 trade-off를 결정했는지 잘 설명해야 한다.

시간이 남는다면 규모 확장성 이슈를 논하는 것도 좋다.

확장 예시

- 수직적, 수평적 규모 확장
- SQL, NoSQL
- master-slave
- replica 읽기 연산
- 일관성 모델
- 데이터 베이스 샤딩

논의 예시

- 웹 계층 무상태로 운영
- 가능한 많은 데이터 캐시 방법
- 여러 데이터 센터를 지원할 방법
- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기
- 핵심 메트릭에 대한 모니터링 (QPS, 지연시간 등)
