# 14장 유튜브 설계

# 1단계 문제 이해 및 설계 범위 확정

영상 스트리밍, 댓글, 좋아요, 재생목록 저장, 구독 등

질문 목록

- 가장 중요한 기능
- 지원 클라이언트
- 일간 능동 사용자 수
- 사용자가 소비하는 시간
- 다국어 지원 여부
- 비디오 파일 크기 제한
- 클라우드 서비스 사용 여부

이번 장에서 초점을 둘 기능은 다음과 같다.

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 안정성
- 지원 클라이언트 : 모바일, 웹, TV

### 개략적 규모 추정

- DAU : 500만
- 한 사용자는 하루 평균 5개의 비디오 시청
- 10%의 사용자가 하루에 1 비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장 용량 150TB / day
- CDN 비용 1GB당 0.02 라고 가정하면 하루 15만달러

# 2단계 개략적 설계안 제시 및 동의 구하기

이 시스템은 사용자 단말, CDN, API 서버 세가지로 나뉘게 된다.

### 비디오 업로드 절차

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/82d1fb3b-d248-4481-ab55-4a851aa7810d)

- 사용자 : 단말을 통해 유튜브를 시청한다.
- 로드 밸런서 : API 서버에 요청을 고르게 분산한다.
- API 서버 : 비디오 스트리밍을 제외한 다른 모든 요청을 처리한다.
- 메타데이터 DB : 비디오의 메타데이터를 보관한다. (샤딩 및 복제를 적용한다)
- 메타데이터 캐시 : 성능을 높이기 위해 메타데이터와 사용자 객체는 캐시한다.
- 원본 저장소 : 원본 비디오를 보관할 대형 BLOB이다.
- 트랜스코드 서버 : 비디오 인코딩, 포맷 변환하는 절차.
- 트랜스코딩 비디오 저장소 : 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- CDN : 비디오 캐시
- 트랜스 코딩 완료 큐 : 트랜스코딩 완료 이벤트 보관
- 트랜스코딩 완료 핸들러 : 트랜스코딩 완료 큐에서 이벤트를 꺼내어 메타데이터 캐시와 DB를 갱신할 작업 서버

**프로세스 a: 비디오 업로드**

1. 비디오를 원본 저장소에 업로드한다.
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스 코딩이 완료되면 두 가지 작업이 비동기로 진행된다.
    1. 트랜스코딩 비디오 저장소에 업로드
    2. 트랜스 코딩 완료 이벤트를 큐에 넣는다.
        1. 트랜스코딩 완료된 비디오를 CDN에 올린다.
        2. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다.
        3. 메타데이터 DB와 캐시 갱신
4. API 서버가 스트리밍 준비를 알린다.

**프로세스 b: 메타데이터 갱신**

원본 저장소에 파일이 업로드되는 동안, 병렬적으로 캐시와 DB에 비디오 메타데이터 갱신을 한다.

### 비디오 스트리밍 절차

스트리밍 프로토콜은 다음과 같은 것이 있다.

- MPEG-DASH : Dynamic Adaptive Streaming over HTTP
- 애플의 HLS : HTTP Live Streaming
- MS의 Smooth Streaming
- 어도비의 Adobe HTTP Dynamic Streaming

비디오는 단말에서 가장 가까운 CDN에서 바로 전송되어 지연이 아주 낮다.

# 3단계 상세 설계

### 비디오 트랜스 코딩

비디오가 모든 단말에서 순조롭게 재생되려면, 다른 단말과 호환되는 비트레이트 포맷으로 저장되어야 한다.

고화질 비디오를 재생하려면 비트레이트가 높아야하고, 컴퓨팅 파워와 인터넷 회선 속도도 중요하다.

- raw video는 저장 공간을 많이 차지한다.
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다. (여러방향으로 인코딩 필요)
- 사용자에게 끊김 없는 고화질 비디오를 보장하려면, 인터넷 대역폭에 맞는 화질의 영상을 전송해야한다.
- 모바일 단말은 네트워크 상황이 달라질 수 있어서 화질이 변경될 여지가 있다.

인코딩 포맷

- 컨테이너 : 비디오 파일, 오디오, 메타데이터 등
- 코덱 : 비디오 화질을 보존하며 파일 크기를 줄이려는 압축 알고리즘

### 유향 비순환 그래프 모델

비디오 트랜스코딩은 각자 창작자만의 비디오 프로세싱 요구사항을 갖고있다.

각기 다른 유형의 프로세싱 파이브라인을 가져야 하고,  병렬성을 높이기 위해선 적절한 수준의 추상화를 도입해야 한다.

페이스북은 DAG 프로그래밍 모델을 도입해서 작업을 단계별로 배열할 수 있도록 한다.

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/59aecfb1-8491-40e9-a523-bb014ef6bc27)

- 검사 : 좋은 품질의 비디오인지, 손상은 없는지
- 비디오 인코딩 : 비디오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩한다. (360, 720, 1080등)
- 섬네일 : 사용자가 업로드한 이미지나 비디오에서 추출된 이미지
- 워터마크 : 비디오에 대한 식별정보를 위해 오버레이로 표시

### 비디오 트랜스코딩 아키텍처

![image](https://github.com/4k-study/book-System-Design-Interview/assets/85796588/604b93e3-3cfb-46eb-95c8-467a972d431b)

**전처리기**

- 비디오 분할 : 비디오 스트림을 GOP 단위로 쪼갠다.
- DAG 생성 : 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만들어낸다.
- 데이터 캐시 : 전처리기는 GOP와 메타데이터를 임시 저장소에 보관하여 비디오 인코딩을 한다.

**DAG 스케줄러**

DAG 그래프를 몇 단계로 분할한 다음에 그 각각을 자원 관리자의 작업 큐에 집어 넣는다.

- 각 작업을 작업 큐에 집어 넣는다.
- 각 작업을 순서대로 쪼개어 처리한다.

**자원 관리자**

자원 배분을 효과적으로 수행하는 역할이다.

작업 큐, 작업 서버 큐, 실행 큐와 스케줄러로 구성된다.

- 작업 큐 : 실행할 작업이 보관되어 있는 우선순위 큐
- 작업 서버 큐 : 작업 서버의 가용 상태 정보가 보관되어 있는 우선순위 큐
- 실행 큐 : 현재 실행중인 작업 및 작업 서버 정보가 보관되어있는 큐
- 작업 스케줄러 : 최적의 작업/서버 조합을 골라, 해당 작업 서버가 작업을 수행하도록 지시한다.

실행 방법

1. 작업 관리자는 작업 큐에서 작업을 꺼낸다.
2. 작업을 수행하기 적절한 작업 서버를 골라 지시한다.
3. 작업과 실행 서버 정보를 실행 큐에 넣는다.
4. 작업 이완료되면 작업 스케줄러는 해당 작업을 실행 큐에서 제거한다.

**작업 서버**

DAG에 정의된 작업을 수행하고, 작업 서버도 구분하여 관리한다.

**임시 저장소**

저장할 데이터 유형, 키그, 빈도, 데이터 유효 기간에 따라 다르다.

보통은 크기가 작기 때문에 메모리에 캐시해두면 된다. 크기가 큰 경우는 BLOB 저장소에 두는 것이 바람직하다.

### 시스템 최적화

**속도 최적화**

- 하나의 비디오를 GOP로 분할하여 업로드 한다.
- 업로드 센터를 여러 곳에 둔다.
- 모든 절차를 병렬화 한다. (메시지 큐)

**안정성 최적화**

- 미리 사인된 업로드 URL만 사용할 수 있도록 한다. (S3)
- 비디오 저작원을 위해 DRM, AES, 워터마크 등을 사용한다.

**비용 최적화**

CDN이 핵심이자, 비용이 크다.

1. 인기 비디오는 CDN을 통해 재생한다. / 비인기는 비디오 서버를 통해 재생한다.
2. 비인기, 짧은 비디오는 인코딩을 할 필요가 없다.
3. 특정 지역에서 인기 비디오는 다른 CDN 서버에 옮길필요가 없다.
4. CDN 직접 구축

### 오류 처리

- 회복 가능 오류 : 몇 번 재시도 한다.
- 회복 불가능 오류 : 작업을 중단하고 적절한 오류 코드를 반환한다.

# 4단계 마무리

추가로 논의하면 좋은 것들

- API 계층의 규모 확장성 확보 방안 : 수평적 규모 확장
- DB 계층의 규모 확장성 확보 방안 : (다중화, 샤딩)
- 라이브 스트리밍 : 응답지연, 프로토콜 선정
- 비디오 삭제
